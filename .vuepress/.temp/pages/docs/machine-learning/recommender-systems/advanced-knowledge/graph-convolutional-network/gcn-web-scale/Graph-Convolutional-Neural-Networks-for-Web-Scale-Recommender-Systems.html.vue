<template><div><h1 id="用于大规模推荐系统的图卷积神经网络" tabindex="-1"><a class="header-anchor" href="#用于大规模推荐系统的图卷积神经网络" aria-hidden="true">#</a> 用于大规模推荐系统的图卷积神经网络</h1>
<ul>
<li><RouterLink to="/docs/machine-learning/recommender-systems/advanced-knowledge/graph-convolutional-network/advanced-knowledge.html">返回上层目录</RouterLink></li>
<li><a href="#%E5%89%8D%E8%A8%80">前言</a></li>
<li><a href="#%E6%A8%A1%E5%9E%8B%E7%BB%93%E6%9E%84">模型结构</a></li>
<li><a href="#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">模型训练</a>
<ul>
<li>[Importance-based neighborhoods](#Importance-based neighborhoods)</li>
<li>[Stacking convolutions](#Stacking convolutions)</li>
<li>[Loss function](#Loss function)</li>
</ul>
</li>
</ul>
<p><img src="@source/docs/machine-learning/recommender-systems/advanced-knowledge/graph-convolutional-network/gcn-web-scale/pic/gcn-ws-rs-paper-title.png" alt="gcn-ws-rs-paper-title"></p>
<blockquote>
<p>论文：Graph Convolutional Neural Networks for Web-Scale Recommender Systems
作者：Rex Ying, Ruining He, Kaifeng Chen, Pong Eksombatchai
来源：KDD 2018</p>
</blockquote>
<p>PDF: <a href="https://arxiv.org/pdf/1806.01973.pdf" target="_blank" rel="noopener noreferrer"><em>Graph Convolutional Neural Networks for Web-Scale Recommender Systems</em><ExternalLinkIcon/></a></p>
<h1 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h1>
<p>这篇文章是Pinterest将GCN成功应用在大规模真实场景的论文，唯一可惜的是没有公开源码。</p>
<p><a href="https://www.pinterest.com" target="_blank" rel="noopener noreferrer">Pinterest<ExternalLinkIcon/></a>是世界上最大的图片社交分享网站。网站允许用户创建和管理主题图片集合，例如事件、兴趣和爱好。</p>
<p><img src="@source/docs/machine-learning/recommender-systems/advanced-knowledge/graph-convolutional-network/gcn-web-scale/pic/Pinterest.png" alt="Pinterest"></p>
<p>论文包含了理论创新和实际落地实现中的一些工程优化。这里对算法理论这块做一下简单记录。</p>
<p>这篇文章虽然说是GCN算法，但是全文看下来其实和卷积并没有很大的关系。GCN算法大多数都是端到端的计算，需要在整个graph上训练。这样的话很难将算法扩展应用到实际的大规模工业应用上。</p>
<p>所以文章提出了一个局部卷积的概念，不在全局的graph上优化算法，而是给特定的节点形成一个包含有限领域节点的子图，在子图上构造局部卷积，然后不同节点共享同样的局部卷积参数，也许正是因为要共享参数，所以作者把这个叫做卷积吧。</p>
<h1 id="模型结构" tabindex="-1"><a class="header-anchor" href="#模型结构" aria-hidden="true">#</a> 模型结构</h1>
<p>下图是论文提出来的卷积模型结构</p>
<p><img src="@source/docs/machine-learning/recommender-systems/advanced-knowledge/graph-convolutional-network/gcn-web-scale/pic/gcn-ws-rs-paper-model.png" alt="gcn-ws-rs-paper-model"></p>
<p>整个算法中，局部卷积算法'CONVOLVE'应该是最核心的部分。</p>
<p><img src="@source/docs/machine-learning/recommender-systems/advanced-knowledge/graph-convolutional-network/gcn-web-scale/pic/gcn-ws-rs-paper-local-conv.png" alt="gcn-ws-rs-paper-local-conv"></p>
<p>这个CONVOLVE是逐点优化的算法，所以输入是当前计算的节点u的embedding，以及它所对应的领域节点的embedding。而<strong>具体的卷积操作其实就是一些全联接构造成的映射</strong>。</p>
<p>分析一下上图的后面三行伪代码。</p>
<p><strong>第一行</strong>里面的hν指的是领域节点v的embedding，这里感觉作者没写清楚，我刚开始也没看明白，后来看了图才看明白。</p>
<p>一个CONVOLVE模块（流程图中的那三行伪代码）就是如下图这样的一个模块：</p>
<p><img src="@source/docs/machine-learning/recommender-systems/advanced-knowledge/graph-convolutional-network/gcn-web-scale/pic/gcn-ws-rs-paper-local-conv-desc.png" alt="gcn-ws-rs-paper-local-conv-desc"></p>
<p>先是对节点的领域节点经过Q映射后，再利用weight-pooling函数γ让输出的维度和输入保持一致，生成所有领域节点统一的embedding向量<span v-pre class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">h_{N(A)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0496em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">A</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span>。</p>
<p><strong>第二行</strong>的伪代码描述的是节点embedding的更新，直接把上一层或者初始的embedding和领域节点embedding一起concate起来，再加上一层全联接就可以生成新的节点embedding。第三行的代码只是对输出的节点embedding做了L2归一化，让训练更稳定。</p>
<p>这一个CONVOLVE里的参数，比如Q,q,W,w这些都是<strong>共享</strong>的，每个节点都一样。所以把这个叫卷积吧。。</p>
<h1 id="模型训练" tabindex="-1"><a class="header-anchor" href="#模型训练" aria-hidden="true">#</a> 模型训练</h1>
<p>现在最核心的算法模块有了，需要先构造输入，输入是按节点迭代，那么每次输入CONVOLVE的就是当前节点，和选择出来的领域。那么领域怎么选？</p>
<h2 id="importance-based-neighborhoods" tabindex="-1"><a class="header-anchor" href="#importance-based-neighborhoods" aria-hidden="true">#</a> Importance-based neighborhoods</h2>
<p>作者为了统一每个节点的领域个数，已经进一步引入每个领域节点对当前节点的重要性，采用了随机游走的策略来生成节点的领域。并且通过计算随机游走对顶点的访问次数的 𝐿1 归一化值。来定义领域节点的重要性，按对定点的访问次数排序后取top-T个节点作为当前节点的领域。</p>
<p>在分析代码流程图的时候，里面的weight-pooling函数的weight方式并没有提到，其实就是这里这里随机游走产生的这个L1归一化值。</p>
<p>其实到这里这个算法也勉强能用了，不过作者为了让这个算法更像卷积，进一步将CONVOLVE模块进行了stack。</p>
<h2 id="stacking-convolutions" tabindex="-1"><a class="header-anchor" href="#stacking-convolutions" aria-hidden="true">#</a> Stacking convolutions</h2>
<p>思路比较简单，就是把CONVOLVE输出的embedding，再传入一个CONVOLVE，类似多层全联接一样，连起来。代码写起来可能会比较麻烦了，因为不同节点的领域不一样，那么堆叠到第二层的时候，输入CONVOLVE的节点就是上一层CONVOLVE的minibatch的节点的领域的领域。有点拗口。具体流程图如下：</p>
<p><img src="@source/docs/machine-learning/recommender-systems/advanced-knowledge/graph-convolutional-network/gcn-web-scale/pic/gcn-ws-rs-paper-model-tranning.png" alt="gcn-ws-rs-paper-model-tranning"></p>
<p>1-7行的循环：获得集合M中从源节点出发，path为1到K的节点集合</p>
<p>8-14循环：获得每一层的embed</p>
<p>5-17行：更新embedding</p>
<p>具体分两部分。</p>
<p>第一部分，首先把每一层里节点的领域都计算好。（流程图里smpling neighborhoods of minibatch nodes下的代码）</p>
<p>第二部分就是循环计算每一层的CONVOLVE，把上一层CONVOLVE的输出作为下一层CONVOLVE的输入。</p>
<p>算法的最后是把最后一层CONVOLVE的输出再经过G1和G2做全联接映射后输出最终的节点embedding。</p>
<p>这里需要注意的是，前面我说过一个CONVOLVE的参数都是共享，这里的共享指的是同一层的CONVOLVE。对应不同层之间的CONVOLVE不共享参数。</p>
<p>能发现，这<strong>整个网络结构确实很像一个多层卷积网络</strong>，输入是节点和节点领域embedding，输出是新的节点embedding。</p>
<p>这个针对不同任务已经完全能够迁移作为backbone。</p>
<h2 id="loss-function" tabindex="-1"><a class="header-anchor" href="#loss-function" aria-hidden="true">#</a> Loss function</h2>
<p>模型训练的目标是让有标记的(query, item)pair对的embedding更接近。</p>
<p>作者定义的损失函数是hinge loss:</p>
<p v-pre class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">J</mi><mi mathvariant="script">G</mi></msub><mo stretchy="false">(</mo><msub><mi>z</mi><mi>q</mi></msub><msub><mi>z</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi mathvariant="double-struck">E</mi><mrow><msub><mi>n</mi><mi>k</mi></msub><mo>∼</mo><msub><mi>P</mi><mi>n</mi></msub><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo></mrow></msub><mtext>max</mtext><mrow><mo fence="true">{</mo><mn>0</mn><mo separator="true">,</mo><msub><mi>z</mi><mi>q</mi></msub><msub><mi>z</mi><msub><mtext>neg</mtext><mi>k</mi></msub></msub><mo>−</mo><msub><mi>z</mi><mi>q</mi></msub><mo>⋅</mo><msub><mi>z</mi><mi>i</mi></msub><mo>+</mo><mi mathvariant="normal">Δ</mi><mo fence="true">}</mo></mrow></mrow><annotation encoding="application/x-tex">
\mathcal{J}_{\mathcal{G}}(z_qz_i)=\mathbb{E}_{n_k\sim P_n(q)}\text{max}\left\{0,z_qz_{\text{neg}_k}-z_q\cdot z_i+\Delta\right\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.18472em;">J</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.0593em;">G</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2181em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2052em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord">max</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">{</span></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">neg</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2302em;"><span style="top:-2.2341em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2659em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">Δ</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">}</span></span></span></span></span></span></span></p>
<p>文章后面还写了一些实际实现工程中的加速优化，这里就不说了。大家可以直接去看原文，或者这里看这哥们<a href="https://davidham3.github.io/blog/2018/06/17/graph-convolutional-neural-networks-for-web-scale-recommender-systems/" target="_blank" rel="noopener noreferrer">翻译的文章<ExternalLinkIcon/></a>。</p>
<h1 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h1>
<ul>
<li><a href="https://blog.csdn.net/sxf1061926959/article/details/92402481" target="_blank" rel="noopener noreferrer">【GCN】: Graph Convolutional Neural Networks for Web-Scale Recommender Systems<ExternalLinkIcon/></a></li>
<li><a href="https://davidham3.github.io/blog/2018/06/17/graph-convolutional-neural-networks-for-web-scale-recommender-systems/" target="_blank" rel="noopener noreferrer">翻译：Graph Convolutional Neural Networks for Web-Scale Recommender Systems<ExternalLinkIcon/></a></li>
<li><a href="https://zhuanlan.zhihu.com/p/45097523" target="_blank" rel="noopener noreferrer">【Read3】Pinterest使用的推荐系统<ExternalLinkIcon/></a></li>
</ul>
<p>本文参考了这几篇文章。</p>
</div></template>


